generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model build_bom_line {
  id            BigInt      @id @default(autoincrement())
  build_id      BigInt
  part_id       BigInt
  required_qty  Decimal     @default(0) @db.Decimal(12, 4)
  allocated_qty Decimal     @default(0) @db.Decimal(12, 4)
  consumed_qty  Decimal     @default(0) @db.Decimal(12, 4)
  source        String      @default("COMMISSION_SHEET")
  notes         String?
  builds        builds      @relation(fields: [build_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  part_master   part_master @relation(fields: [part_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([build_id], map: "idx_build_bom_build")
  @@index([part_id], map: "idx_build_bom_part")
}

model build_documents {
  id                   BigInt                 @id @default(autoincrement())
  build_id             BigInt
  doc_type             String                 @default("BUILD_BOOK")
  filename             String
  storage_url          String?
  uploaded_by          String?
  uploaded_at          DateTime               @default(now()) @db.Timestamptz(6)
  meta_json            Json                   @default("{}")
  builds               builds                 @relation(fields: [build_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  document_extractions document_extractions[]
}

model builds {
  id              BigInt            @id @default(autoincrement())
  code            String            @unique
  model           String?
  status          build_status      @default(PLANNED)
  eta_date        DateTime?         @db.Date
  spec_json       Json              @default("{}")
  created_at      DateTime          @default(now()) @db.Timestamptz(6)
  updated_at      DateTime          @default(now()) @db.Timestamptz(6)
  build_bom_line  build_bom_line[]
  build_documents build_documents[]
  part_instance   part_instance[]
  tasks           tasks[]
  work_orders     work_orders[]
}

model document_extractions {
  id              BigInt          @id @default(autoincrement())
  document_id     BigInt
  status          String          @default("PENDING")
  extracted_json  Json            @default("{}")
  created_at      DateTime        @default(now()) @db.Timestamptz(6)
  updated_at      DateTime        @default(now()) @db.Timestamptz(6)
  build_documents build_documents @relation(fields: [document_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model inspection_records {
  id                BigInt         @id @default(autoincrement())
  work_order_id     BigInt?
  instance_id       BigInt?
  result            String
  measurements_json Json           @default("{}")
  notes             String?
  created_at        DateTime       @default(now()) @db.Timestamptz(6)
  part_instance     part_instance? @relation(fields: [instance_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  work_orders       work_orders?   @relation(fields: [work_order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model inventory_lot {
  id              BigInt           @id @default(autoincrement())
  part_id         BigInt
  lot_code        String?
  location_id     BigInt?
  qty_on_hand     Decimal          @default(0) @db.Decimal(12, 4)
  unit_cost       Decimal?         @db.Decimal(12, 4)
  received_at     DateTime?        @db.Timestamptz(6)
  last_counted_at DateTime?        @db.Timestamptz(6)
  created_at      DateTime         @default(now()) @db.Timestamptz(6)
  locations       locations?       @relation(fields: [location_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  part_master     part_master      @relation(fields: [part_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  wo_consumption  wo_consumption[]
  wo_production   wo_production[]

  @@index([part_id], map: "idx_inventory_lot_part")
}

model locations {
  id            BigInt          @id @default(autoincrement())
  name          String          @unique
  inventory_lot inventory_lot[]
  part_instance part_instance[]
}

model part_instance {
  id                  BigInt               @id @default(autoincrement())
  part_id             BigInt
  serial_no           String               @unique
  status              instance_status      @default(NEW)
  location_id         BigInt?
  current_build_id    BigInt?
  parent_instance_id  BigInt?
  attributes_json     Json                 @default("{}")
  updated_at          DateTime             @default(now()) @db.Timestamptz(6)
  inspection_records  inspection_records[]
  builds              builds?              @relation(fields: [current_build_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  locations           locations?           @relation(fields: [location_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  part_instance       part_instance?       @relation("part_instanceTopart_instance", fields: [parent_instance_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_part_instance part_instance[]      @relation("part_instanceTopart_instance")
  part_master         part_master          @relation(fields: [part_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  wo_consumption      wo_consumption[]
  wo_production       wo_production[]
  work_orders         work_orders[]

  @@index([current_build_id], map: "idx_part_instance_build")
  @@index([part_id], map: "idx_part_instance_part")
}

model part_master {
  id                    BigInt           @id @default(autoincrement())
  sku                   String           @unique
  name                  String
  type                  part_type
  uom                   String           @default("EA")
  make_buy              make_buy         @default(BUY)
  is_serialized         Boolean          @default(false)
  default_yield         Decimal          @default(1.0000) @db.Decimal(6, 4)
  spec_json             Json             @default("{}")
  preferred_supplier_id BigInt?
  created_at            DateTime         @default(now()) @db.Timestamptz(6)
  updated_at            DateTime         @default(now()) @db.Timestamptz(6)
  build_bom_line        build_bom_line[]
  inventory_lot         inventory_lot[]
  part_instance         part_instance[]
  suppliers             suppliers?       @relation(fields: [preferred_supplier_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  wo_consumption        wo_consumption[]
  wo_production         wo_production[]
  work_orders           work_orders[]

  @@index([name(ops: raw("gin_trgm_ops"))], map: "idx_part_master_name_trgm", type: Gin)
  @@index([sku(ops: raw("gin_trgm_ops"))], map: "idx_part_master_sku_trgm", type: Gin)
}

model phases {
  id             BigInt           @id @default(autoincrement())
  seq            Int              @unique
  name           String
  description    String?
  task_templates task_templates[]
  tasks          tasks[]
}

model suppliers {
  id           BigInt        @id @default(autoincrement())
  name         String
  region       String?
  contact_json Json?         @default("{}")
  created_at   DateTime      @default(now()) @db.Timestamptz(6)
  part_master  part_master[]
}

model task_events {
  id           BigInt          @id @default(autoincrement())
  task_id      BigInt
  event_type   task_event_type
  occurred_at  DateTime        @default(now()) @db.Timestamptz(6)
  actor        String?
  note         String?
  payload_json Json            @default("{}")
  tasks        tasks           @relation(fields: [task_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([task_id, occurred_at(sort: Desc)], map: "idx_task_events_task_time")
}

model task_templates {
  id                     BigInt   @id @default(autoincrement())
  phase_id               BigInt?
  name                   String
  default_duration_hours Decimal? @db.Decimal(8, 2)
  spec_json              Json     @default("{}")
  phases                 phases?  @relation(fields: [phase_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model tasks {
  id           BigInt        @id @default(autoincrement())
  build_id     BigInt
  phase_id     BigInt?
  name         String
  status       task_status   @default(NOT_STARTED)
  owner        String?
  started_at   DateTime?     @db.Timestamptz(6)
  completed_at DateTime?     @db.Timestamptz(6)
  updated_at   DateTime      @default(now()) @db.Timestamptz(6)
  task_events  task_events[]
  builds       builds        @relation(fields: [build_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  phases       phases?       @relation(fields: [phase_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([build_id], map: "idx_tasks_build")
  @@index([phase_id], map: "idx_tasks_phase")
}

model wo_consumption {
  id                    BigInt         @id @default(autoincrement())
  work_order_id         BigInt
  part_id               BigInt
  qty                   Decimal        @db.Decimal(12, 4)
  from_inventory_lot_id BigInt?
  from_instance_id      BigInt?
  consumed_at           DateTime       @default(now()) @db.Timestamptz(6)
  part_instance         part_instance? @relation(fields: [from_instance_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  inventory_lot         inventory_lot? @relation(fields: [from_inventory_lot_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  part_master           part_master    @relation(fields: [part_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  work_orders           work_orders    @relation(fields: [work_order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model wo_production {
  id                   BigInt         @id @default(autoincrement())
  work_order_id        BigInt
  part_id              BigInt
  qty                  Decimal        @db.Decimal(12, 4)
  produced_instance_id BigInt?
  to_inventory_lot_id  BigInt?
  produced_at          DateTime       @default(now()) @db.Timestamptz(6)
  part_master          part_master    @relation(fields: [part_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  part_instance        part_instance? @relation(fields: [produced_instance_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  inventory_lot        inventory_lot? @relation(fields: [to_inventory_lot_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  work_orders          work_orders    @relation(fields: [work_order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model work_orders {
  id                 BigInt               @id @default(autoincrement())
  type               wo_type
  status             wo_status            @default(PLANNED)
  for_build_id       BigInt?
  target_part_id     BigInt
  target_qty         Decimal              @default(1) @db.Decimal(12, 4)
  input_instance_id  BigInt?
  due_date           DateTime?            @db.Date
  notes              String?
  created_at         DateTime             @default(now()) @db.Timestamptz(6)
  updated_at         DateTime             @default(now()) @db.Timestamptz(6)
  inspection_records inspection_records[]
  wo_consumption     wo_consumption[]
  wo_production      wo_production[]
  builds             builds?              @relation(fields: [for_build_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  part_instance      part_instance?       @relation(fields: [input_instance_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  part_master        part_master          @relation(fields: [target_part_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([for_build_id], map: "idx_work_orders_build")
  @@index([target_part_id], map: "idx_work_orders_target_part")
}

enum build_status {
  PLANNED
  IN_PROGRESS
  HOLD
  DONE
}

enum instance_status {
  NEW
  IN_SERVICE
  CORE
  IN_REBUILD
  SCRAPPED
  CONSUMED
}

enum make_buy {
  MAKE
  BUY
  REBUILD
  BUY_AND_REBUILD
}

enum part_type {
  COMPONENT
  SUBASSEMBLY
  ASSEMBLY
  MATERIAL
  FASTENER
  SERVICE
}

enum task_event_type {
  START
  PAUSE
  RESUME
  COMPLETE
  BLOCK
  UNBLOCK
  NOTE
}

enum task_status {
  NOT_STARTED
  IN_PROGRESS
  PAUSED
  DONE
  BLOCKED
}

enum wo_status {
  PLANNED
  IN_PROGRESS
  HOLD
  DONE
  CANCELLED
}

enum wo_type {
  MAKE
  REBUILD
  REPAIR
  DISASSEMBLY
}
